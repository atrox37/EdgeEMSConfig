name: Build & Publish Tauri App (pnpm + S3 + 3 platforms)

on:
  push:
    tags:
      - "v*.*.*"   # 推 tag 时触发，例如 v0.1.0、v1.0.0

jobs:
  build:
    name: Build per platform
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        include:
          - os: windows-latest
            artifact_name: windows-bundle
            bundle_subdir: msi
            ext: .msi
          - os: ubuntu-latest
            artifact_name: linux-bundle
            bundle_subdir: appimage
            ext: .AppImage
          - os: macos-latest
            artifact_name: macos-bundle
            bundle_subdir: dmg
            ext: .dmg

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Enable corepack & install pnpm
        run: |
          corepack enable
          corepack prepare pnpm@latest --activate

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      # 只在 Linux 安装系统依赖（Ubuntu 24.04 / noble）
      - name: Install Linux system dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libglib2.0-dev \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            pkg-config \
            patchelf

      - name: Install frontend deps (pnpm)
        run: pnpm install

      # 如果 tauri.conf.json 里已经配置 beforeBuildCommand，可以去掉这一步
      - name: Build frontend (optional)
        run: pnpm build
        continue-on-error: true

      # 从 base64 还原 Tauri 私钥文件，并做调试输出（不会泄露内容）
      - name: Restore Tauri private key from base64 and debug
        shell: bash
        env:
          TAURI_SIGNING_PRIVATE_KEY_BASE64: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_BASE64 }}
        run: |
          # 将 Base64 解码为二进制私钥文件 tauri.key
          echo "$TAURI_SIGNING_PRIVATE_KEY_BASE64" | base64 -d > tauri.key

          echo "==== KEY CHECKSUM (sha256) ===="
          sha256sum tauri.key 2>/dev/null || shasum -a 256 tauri.key

          echo "==== KEY LINE COUNT ===="
          wc -l < tauri.key

          echo "==== KEY HEADER (first line) ===="
          head -n 1 tauri.key

      # 使用官方 Tauri Action 打包当前平台
      - name: Build Tauri App
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # 这里传的是“私钥文件路径”，不是内容
          TAURI_SIGNING_PRIVATE_KEY: ${{ github.workspace }}/tauri.key
          # ⚠ 已经不用 PASSWORD（请确认你用的是无密码 key）
        with:
          tagName: ${{ github.ref_name }} # 例如 v0.1.0
          releaseName: "Edge Desktop ${{ github.ref_name }}"
          releaseBody: "Auto build from GitHub Actions"

      # 收集当前平台的安装包 + .sig，打包成 artifact
      - name: Collect bundle artifact
        shell: bash
        run: |
          BUNDLE_DIR="src-tauri/target/release/bundle/${{ matrix.bundle_subdir }}"
          echo "Bundle dir: $BUNDLE_DIR"
          ls -R "$BUNDLE_DIR"

          FILE=$(ls "$BUNDLE_DIR"/*${{ matrix.ext }} | head -n 1)
          SIG="$FILE.sig"

          echo "Found file: $FILE"
          echo "Found sig:  $SIG"

          mkdir -p upload/${{ matrix.artifact_name }}
          cp "$FILE" "$SIG" "upload/${{ matrix.artifact_name }}/"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: upload/${{ matrix.artifact_name }}

  publish:
    name: Publish to S3
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 下载三个平台的构建产物
      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-bundle
          path: artifacts/windows

      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: linux-bundle
          path: artifacts/linux

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: macos-bundle
          path: artifacts/macos

      # 整理成 dist/windows | dist/linux | dist/macos 目录结构
      - name: Prepare dist layout
        shell: bash
        run: |
          mkdir -p dist/windows dist/linux dist/macos
          cp artifacts/windows/* dist/windows/
          cp artifacts/linux/* dist/linux/
          cp artifacts/macos/* dist/macos/

          echo "dist layout:"
          ls -R dist

      # 生成 latest.json（脚本里会用 dist 下的文件名和 .sig）
      - name: Generate latest.json
        shell: bash
        env:
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          node scripts/generate-latest.js ${{ github.ref_name }}

      # 配好 AWS 凭证
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup AWS CLI
        uses: aws-actions/aws-cli-setup@v4

      # 上传 dist 和 latest.json 到 S3
      - name: Upload to S3
        shell: bash
        env:
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
        run: |
          TAG=${GITHUB_REF_NAME}
          echo "Uploading dist to s3://${S3_BUCKET}/releases/${TAG}/"
          aws s3 sync dist "s3://${S3_BUCKET}/releases/${TAG}/"

          echo "Uploading latest.json to s3://${S3_BUCKET}/latest.json"
          aws s3 cp latest.json "s3://${S3_BUCKET}/latest.json" --content-type "application/json"
