name: Build and Publish Tauri (Win/Linux/macOS) to S3

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build:
    name: Build per platform
    environment: prod
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest, ubuntu-22.04-arm]
        include:
          - os: windows-latest
            bundle_subdir: msi
          - os: ubuntu-latest
            bundle_subdir: appimage
          - os: macos-latest
            bundle_subdir: dmg
          - os: ubuntu-22.04-arm
            bundle_subdir: appimage

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Linux dependencies (Ubuntu only)
        if: matrix.os == 'ubuntu-latest' || matrix.os == 'ubuntu-22.04-arm'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libglib2.0-dev \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            pkg-config \
            patchelf \
            xdg-utils

      - name: Install frontend deps
        run: pnpm install

      - name: Update version from tag
        run: |
          # 从 tag 中提取版本号（去掉 'v' 前缀）
          VERSION=${GITHUB_REF_NAME#v}
          echo "Updating version to $VERSION"
          
          # 使用 Node.js 更新版本号（跨平台）
          node -e "
          const fs = require('fs');
          const version = '$VERSION';
          
          // 更新 package.json
          const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
          pkg.version = version;
          fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          
          // 更新 tauri.conf.json
          const tauriConf = JSON.parse(fs.readFileSync('src-tauri/tauri.conf.json', 'utf8'));
          tauriConf.version = version;
          fs.writeFileSync('src-tauri/tauri.conf.json', JSON.stringify(tauriConf, null, 2) + '\n');
          
          // 更新 Cargo.toml
          let cargoToml = fs.readFileSync('src-tauri/Cargo.toml', 'utf8');
          cargoToml = cargoToml.replace(/^version = \".*\"/m, 'version = \"' + version + '\"');
          fs.writeFileSync('src-tauri/Cargo.toml', cargoToml);
          
          console.log('Version updated successfully to', version);
          "
          
          echo "Verification:"
          echo "package.json: $(grep '"version"' package.json)"
          echo "tauri.conf.json: $(grep '"version"' src-tauri/tauri.conf.json)"
          echo "Cargo.toml: $(grep '^version' src-tauri/Cargo.toml)"

      - name: Build app (Tauri)
        if: matrix.os != 'ubuntu-22.04-arm'
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: Build app (Tauri ARM64)
        if: matrix.os == 'ubuntu-22.04-arm'
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          args: --target aarch64-unknown-linux-gnu

      - name: Upload bundle artifact (ARM64)
        if: matrix.os == 'ubuntu-22.04-arm'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}-bundle
          path: src-tauri/target/aarch64-unknown-linux-gnu/release/bundle/appimage/

      - name: Upload bundle artifact (Other platforms)
        if: matrix.os != 'ubuntu-22.04-arm'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}-bundle
          path: src-tauri/target/release/bundle/${{ matrix.bundle_subdir }}/

  publish:
    name: Publish to S3
    environment: prod
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Debug artifacts structure
        run: |
          echo "Artifacts directory structure:"
          ls -la artifacts/ || echo "artifacts directory not found"
          echo ""
          echo "Looking for ubuntu-22.04-arm-bundle:"
          ls -la artifacts/ubuntu-22.04-arm-bundle/ || echo "ubuntu-22.04-arm-bundle not found"
          echo ""
          echo "All artifacts:"
          find artifacts -type f -o -type d | head -20

      - name: Organize dist (linux-arm64 only)
        run: |
          mkdir -p dist/linux-arm64
          if [ -d "artifacts/ubuntu-22.04-arm-bundle" ]; then
            cp -R artifacts/ubuntu-22.04-arm-bundle/* dist/linux-arm64/
            echo "Files copied successfully"
          else
            echo "Error: artifacts/ubuntu-22.04-arm-bundle directory not found"
            exit 1
          fi
          ls -R dist

      - name: Generate latest.json
        env:
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: node script/generate-latest.js ${{ github.ref_name }}

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Upload dist and latest.json to S3
        env:
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
        run: |
          TAG=${GITHUB_REF_NAME}
          aws s3 sync dist "s3://${S3_BUCKET}/releases/${TAG}/"
          aws s3 cp latest.json "s3://${S3_BUCKET}/latest.json" --content-type "application/json"
